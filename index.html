<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Izzie’s Bikinis — Bikini Blueprint AI</title>
<meta name="description" content="Izzie's Bikinis — Custom swimwear with AI-assisted measurements."/>
<style>
  :root{
    --brand:#e07a7a; --ink:#1f2937; --bg:#fff; --muted:#f8f8f8; --accent:#f1d4d4;
    --ok:#059669; --warn:#d97706; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;background:#fffbd;backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #eee;z-index:30}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand .dot{width:14px;height:14px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px var(--accent)}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .tab{padding:10px 14px;border:1px solid #eee;border-radius:10px;background:#fff;cursor:pointer}
  .tab.active{border-color:var(--brand);box-shadow:0 0 0 2px #0000 inset, 0 0 0 2px var(--accent);color:var(--brand);font-weight:600}
  main{padding:20px 0}
  section{display:none}
  section.active{display:block}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid-2{grid-template-columns:1.2fr .8fr}}
  .card{border:1px solid #eee;border-radius:14px;overflow:hidden;background:#fff}
  .card h3{margin:0;padding:14px 16px;border-bottom:1px solid #eee;background:linear-gradient(#fff, #fdfdfd)}
  .card .body{padding:16px}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #ddd;padding:10px 14px;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.ghost{background:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #eee;background:#fff}
  .warn{color:var(--warn)}
  .ok{color:var(--ok)}
  .bad{color:var(--bad)}
  .muted{color:#6b7280}
  .note{font-size:.92rem;line-height:1.35}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1}
  .row .tight{flex:0 0 auto}
  .field{display:flex;flex-direction:column;gap:6px}
  input[type="text"], input[type="number"], select{
    width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff
  }
  label{font-weight:600}
  .canvasWrap{position:relative;border:1px dashed #ddd;border-radius:12px;overflow:hidden;background:var(--muted);aspect-ratio:3/4;display:flex;align-items:center;justify-content:center}
  canvas{max-width:100%;max-height:100%}
  video{max-width:100%;border-radius:12px}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--accent);color:#7a3a3a;font-weight:600;font-size:.8rem}
  .measureRow{display:grid;grid-template-columns:140px 1fr 120px 140px;gap:8px;align-items:center}
  .bar{height:12px;background:#eee;border-radius:8px;position:relative;overflow:hidden}
  .bar > span{position:absolute;left:0;top:0;bottom:0;background:var(--brand)}
  .rangeLegend{display:flex;justify-content:space-between;font-size:.8rem;color:#6b7280}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f2f2f2;border-radius:6px;padding:2px 6px;border:1px solid #e5e7eb}
  .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .hr{height:1px;background:#eee;margin:12px 0}
  .tick{width:10px;height:10px;border-radius:50%;background:var(--brand);outline:2px solid #fff;box-shadow:0 0 0 2px var(--brand)}
  .legend{display:flex;gap:10px;align-items:center}
  .small{font-size:.88rem}
  .success{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;border-radius:10px;padding:10px}
  .danger{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;border-radius:10px;padding:10px}
  .ghostBox{padding:10px;border-radius:12px;border:1px dashed #e5e7eb;background:#fafafa}
  .inline{display:inline}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <div style="font-weight:800;letter-spacing:.3px">Izzie’s Bikinis</div>
          <div class="muted" style="font-size:.9rem">Custom swim made simple</div>
        </div>
      </div>
      <nav id="nav">
        <button class="tab active" data-tab="home">Home</button>
        <button class="tab" data-tab="products">Shop</button>
        <button class="tab" data-tab="blueprint">Bikini Blueprint AI</button>
        <button class="tab" data-tab="faq">FAQ</button>
        <button class="tab" data-tab="privacy">Privacy</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section id="home" class="active">
      <div class="grid grid-2">
        <div class="card">
          <h3>Made-to-you swimwear</h3>
          <div class="body">
            <p>Every body is unique. Use our <strong>Bikini Blueprint AI</strong> to capture a few simple measurements from your camera or a photo and we’ll translate them into your best-fit bikini pattern.</p>
            <div class="hr"></div>
            <div class="legend small"><span class="tick"></span> <span>Fast, private, on your device—photos never leave your browser unless you choose to submit them with an order.</span></div>
          </div>
        </div>
        <div class="card">
          <h3>How it works</h3>
          <div class="body">
            <ol>
              <li><strong>Calibrate</strong> with a known object (credit card or US letter paper) or enter your height.</li>
              <li><strong>Mark</strong> four widths: Bust, Underbust, Waist, and Hips.</li>
              <li><strong>Review</strong> auto-estimated circumferences & see your <strong>size indicator</strong>.</li>
              <li><strong>Export</strong> results as JSON or copy to clipboard.</li>
            </ol>
            <p class="muted small">Tip: Tight clothing or a snug tank helps. Stand square to camera.</p>
          </div>
        </div>
      </div>
    </section>

    <section id="products">
      <div class="card">
        <h3>Shop (Preview)</h3>
        <div class="body">
          <p>Your product grid goes here. Link this to <a href="https://www.izziesbikinies.com/" target="_blank" rel="noopener">izziesbikinies.com</a> or migrate products later.</p>
        </div>
      </div>
    </section>

    <section id="blueprint">
      <div class="card">
        <h3>Bikini Blueprint AI</h3>
        <div class="body">
          <div class="ghostBox small">
            <strong>Consent & Age Check</strong><br/>
            <label class="small"><input type="checkbox" id="ageCheck"> I confirm I am 18+.</label><br/>
            <label class="small"><input type="checkbox" id="consentCheck"> I consent to processing my image locally in my browser for measurement. I can choose not to upload or submit any image.</label>
          </div>

          <div class="hr"></div>

          <div class="grid grid-2">
            <div>
              <div class="controls">
                <button class="btn" id="useCameraBtn">Use Live Camera</button>
                <label class="btn ghost tight" for="fileInput">Upload Photo</label>
                <input id="fileInput" type="file" accept="image/*" style="display:none">
                <button class="btn" id="captureBtn" disabled>Capture Frame</button>
                <button class="btn" id="clearMarksBtn" disabled>Clear Marks</button>
              </div>

              <div id="mediaZone" class="canvasWrap" aria-live="polite">
                <video id="video" playsinline muted style="display:none"></video>
                <canvas id="canvas" width="720" height="960" aria-label="Measurement canvas"></canvas>
              </div>

              <p class="small muted" style="margin-top:8px">
                <span class="tag">Tip</span> For accurate scale, include a <strong>credit card</strong> (85.6&nbsp;mm wide) or a sheet of <strong>US Letter</strong> (8.5&nbsp;in / 216&nbsp;mm wide) in frame.
              </p>
            </div>

            <div>
              <div class="card">
                <h3>1) Calibrate Scale</h3>
                <div class="body">
                  <div class="row">
                    <div class="field">
                      <label for="calibMode">Calibration method</label>
                      <select id="calibMode">
                        <option value="object" selected>Known object width (recommended)</option>
                        <option value="height">My height</option>
                      </select>
                    </div>
                    <div class="field" id="calibObjectField">
                      <label for="calibObject">Object</label>
                      <select id="calibObject">
                        <option value="85.6">Credit card (85.6 mm)</option>
                        <option value="216">US Letter width (216 mm)</option>
                        <option value="210">A4 width (210 mm)</option>
                        <option value="custom">Custom (mm)</option>
                      </select>
                    </div>
                    <div class="field" id="calibCustomWrap" style="display:none">
                      <label for="calibCustomMm">Custom width (mm)</label>
                      <input type="number" id="calibCustomMm" min="1" step="0.1" placeholder="e.g., 100">
                    </div>
                    <div class="field" id="heightWrap" style="display:none">
                      <label for="userHeight">Your height</label>
                      <div class="row">
                        <input type="number" id="userHeight" min="100" max="230" step="1" placeholder="cm (e.g., 170)">
                        <span class="muted tight small">or</span>
                        <input type="text" id="userHeightFtIn" placeholder="ft'in (e.g., 5'7)">
                      </div>
                    </div>
                  </div>
                  <div class="hr"></div>
                  <div>
                    <p class="small"><strong>Draw calibration line:</strong> Click two points on the <em>object</em> in the image (its left and right edges). We’ll compute pixels-per-mm.</p>
                    <div class="controls">
                      <button class="btn" id="startCalibBtn" disabled>Start Calibration</button>
                      <span id="calibStatus" class="pill muted">Idle</span>
                    </div>
                    <p id="pxPerMm" class="small muted">Scale: —</p>
                  </div>
                </div>
              </div>

              <div class="card" style="margin-top:16px">
                <h3>2) Mark Measurements</h3>
                <div class="body">
                  <p class="small">Click two points <em>horizontally</em> across your body for each line. Use the buttons below to guide which line you’re drawing:</p>
                  <div class="controls">
                    <button class="btn" data-meas="bust" id="btnBust" disabled>Bust</button>
                    <button class="btn" data-meas="underbust" id="btnUnderbust" disabled>Underbust</button>
                    <button class="btn" data-meas="waist" id="btnWaist" disabled>Waist</button>
                    <button class="btn" data-meas="hips" id="btnHips" disabled>Hips</button>
                  </div>
                  <p class="small muted">Drawing: <span id="drawingWhat">None</span></p>
                </div>
              </div>

              <div class="card" style="margin-top:16px">
                <h3>3) Results & Size Indicator</h3>
                <div class="body">
                  <div id="results">
                    <div class="measureRow">
                      <div><strong>Bust</strong></div>
                      <div class="bar"><span id="bar-bust" style="width:0%"></span></div>
                      <div id="bustIn">— in</div>
                      <div class="muted small" id="bustCm">— cm</div>
                    </div>
                    <div class="measureRow">
                      <div><strong>Underbust</strong></div>
                      <div class="bar"><span id="bar-underbust" style="width:0%"></span></div>
                      <div id="underbustIn">— in</div>
                      <div class="muted small" id="underbustCm">— cm</div>
                    </div>
                    <div class="measureRow">
                      <div><strong>Waist</strong></div>
                      <div class="bar"><span id="bar-waist" style="width:0%"></span></div>
                      <div id="waistIn">— in</div>
                      <div class="muted small" id="waistCm">— cm</div>
                    </div>
                    <div class="measureRow">
                      <div><strong>Hips</strong></div>
                      <div class="bar"><span id="bar-hips" style="width:0%"></span></div>
                      <div id="hipsIn">— in</div>
                      <div class="muted small" id="hipsCm">— cm</div>
                    </div>
                    <p class="small muted">Bars scale over a typical range (24–48 in). This is only a visual indicator; your final pattern is graded precisely to your numbers.</p>
                    <div class="hr"></div>
                    <div class="controls">
                      <button class="btn" id="copyBtn" disabled>Copy to Clipboard</button>
                      <button class="btn" id="exportBtn" disabled>Download JSON</button>
                    </div>
                    <p id="statusMsg" class="small"></p>
                  </div>
                </div>
              </div>

              <p class="note small" style="margin-top:12px">
                <strong>Important:</strong> These are <em>estimated</em> circumferences from a single image. For best accuracy, we may confirm with quick follow-ups or a guided tape-measure check at checkout.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="faq">
      <div class="card">
        <h3>FAQ</h3>
        <div class="body">
          <p><strong>Do you store my photos?</strong> No. All processing happens in your browser. Nothing is uploaded unless you choose to submit with your order.</p>
          <p><strong>What if I’m under 18?</strong> Please use the manual tape-measure option with a parent/guardian and do not upload images.</p>
          <p><strong>How accurate is it?</strong> With a clear calibration object and square stance, most users are within ±1–2 cm. We still guarantee alterations if anything feels off.</p>
        </div>
      </div>
    </section>

    <section id="privacy">
      <div class="card">
        <h3>Privacy & Safety</h3>
        <div class="body">
          <ul>
            <li>Images stay on-device by default. You control whether to submit anything during checkout.</li>
            <li>Click <span class="kbd">Clear Marks</span> to remove overlay data; refresh the page to discard images.</li>
            <li>No face detection or biometric identification is performed.</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

<script>
const tabs = document.querySelectorAll('.tab');
const sections = document.querySelectorAll('main section');
tabs.forEach(t=>{
  t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id = t.dataset.tab;
    sections.forEach(s=>s.classList.toggle('active', s.id===id));
  });
});

const ageCheck = document.getElementById('ageCheck');
const consentCheck = document.getElementById('consentCheck');

const useCameraBtn = document.getElementById('useCameraBtn');
const captureBtn = document.getElementById('captureBtn');
const clearMarksBtn = document.getElementById('clearMarksBtn');
const fileInput = document.getElementById('fileInput');

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d',{willReadFrequently:true});

const calibMode = document.getElementById('calibMode');
const calibObject = document.getElementById('calibObject');
const calibCustomWrap = document.getElementById('calibCustomWrap');
const calibCustomMm = document.getElementById('calibCustomMm');
const heightWrap = document.getElementById('heightWrap');
const userHeight = document.getElementById('userHeight');
const userHeightFtIn = document.getElementById('userHeightFtIn');

const startCalibBtn = document.getElementById('startCalibBtn');
const calibStatus = document.getElementById('calibStatus');
const pxPerMmEl = document.getElementById('pxPerMm');

const btnBust = document.getElementById('btnBust');
const btnUnderbust = document.getElementById('btnUnderbust');
const btnWaist = document.getElementById('btnWaist');
const btnHips = document.getElementById('btnHips');
const drawingWhat = document.getElementById('drawingWhat');

const bars = {
  bust: document.getElementById('bar-bust'),
  underbust: document.getElementById('bar-underbust'),
  waist: document.getElementById('bar-waist'),
  hips: document.getElementById('bar-hips'),
};
const outs = {
  bustIn: document.getElementById('bustIn'),
  bustCm: document.getElementById('bustCm'),
  underbustIn: document.getElementById('underbustIn'),
  underbustCm: document.getElementById('underbustCm'),
  waistIn: document.getElementById('waistIn'),
  waistCm: document.getElementById('waistCm'),
  hipsIn: document.getElementById('hipsIn'),
  hipsCm: document.getElementById('hipsCm'),
};
const copyBtn = document.getElementById('copyBtn');
const exportBtn = document.getElementById('exportBtn');
const statusMsg = document.getElementById('statusMsg');

let stream = null;
let imgBitmap = null;
let drawing = null;
let marks = { calib: [], bust: [], underbust: [], waist: [], hips: [] };
let pxPerMm = null;

function mmToIn(mm){ return mm/25.4; }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function heightToMm(){
  if(userHeight.value){
    const cm = parseFloat(userHeight.value);
    if(isFinite(cm) && cm>100 && cm<230) return cm*10;
  }
  const s = userHeightFtIn.value.trim();
  if(s){
    const m = s.match(/^\s*(\d+)\s*'\s*(\d+)\s*"?\s*$/);
    if(m){
      const totalIn = (+m[1])*12 + (+m[2]);
      return totalIn*25.4;
    }
  }
  return null;
}
function enableMeasurementButtons(on){
  [btnBust, btnUnderbust, btnWaist, btnHips, clearMarksBtn].forEach(b=>b.disabled=!on);
}
function requireConsent(){
  const ok = ageCheck.checked && consentCheck.checked;
  useCameraBtn.disabled = !ok;
  captureBtn.disabled = !ok;
  startCalibBtn.disabled = !ok;
  fileInput.disabled = !ok;
  return ok;
}
function drawAll(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(imgBitmap){
    const scale = Math.min(canvas.width/imgBitmap.width, canvas.height/imgBitmap.height);
    const w = imgBitmap.width*scale, h = imgBitmap.height*scale;
    const x = (canvas.width - w)/2, y=(canvas.height - h)/2;
    ctx.drawImage(imgBitmap, x, y, w, h);
  }else if(video.style.display!=="none"){
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  }else{
    ctx.fillStyle="#9ca3af";
    ctx.font="16px system-ui, sans-serif";
    ctx.fillText("Start camera or upload a photo to begin", 20, 40);
  }
  const colors = { calib: "#6366f1", bust: "#ef4444", underbust: "#f59e0b", waist: "#10b981", hips: "#3b82f6" };
  Object.entries(marks).forEach(([k,pts])=>{
    if(pts.length===2){
      ctx.strokeStyle = colors[k]; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y); ctx.lineTo(pts[1].x, pts[1].y); ctx.stroke();
      ctx.fillStyle = colors[k];
      pts.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fill(); });
    }
  });
}
function canvasPointFromEvent(ev){
  const rect = canvas.getBoundingClientRect();
  const x = (ev.clientX - rect.left) * (canvas.width / rect.width);
  const y = (ev.clientY - rect.top) * (canvas.height / rect.height);
  return {x,y};
}

async function startCamera(){
  if(stream){ return; }
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user", width:{ideal:1280}}, audio:false});
    video.srcObject = stream;
    video.style.display = "";
    await video.play();
    captureBtn.disabled = false;
    status("Camera ready. Click Capture when framed.");
    drawFromVideo();
  }catch(err){
    status("Unable to access camera. You can upload a photo instead.", true);
  }
}
function drawFromVideo(){
  if(!video.srcObject) return;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  requestAnimationFrame(drawFromVideo);
}
async function captureFrame(){
  const off = document.createElement('canvas');
  off.width = video.videoWidth; off.height = video.videoHeight;
  off.getContext('2d').drawImage(video,0,0);
  imgBitmap = await createImageBitmap(off);
  video.style.display = "none";
  drawAll();
  status("Captured frame. Now calibrate scale.");
}
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = async ()=>{
    imgBitmap = await createImageBitmap(img);
    video.style.display = "none";
    drawAll();
    status("Photo loaded. Start calibration.");
  };
  img.onerror = ()=>status("Could not load image.", true);
  img.src = url;
});

let calibClickCount = 0;
let currentMeasure = null;

function getObjectWidthMm(){
  if(calibMode.value==="object"){
    let mm = 85.6;
    if(calibObject.value==="custom"){
      mm = parseFloat(calibCustomMm.value);
    }else{
      mm = parseFloat(calibObject.value);
    }
    return isFinite(mm) && mm>0 ? mm : null;
  }else{
    return heightToMm();
  }
}

startCalibBtn.addEventListener('click', ()=>{
  if(!imgBitmap && video.style.display==="none"){
    status("Load an image or capture a frame first.", true); return;
  }
  const refMm = getObjectWidthMm();
  if(!refMm){ status("Please provide a valid calibration value.", true); return; }
  drawing = "calib";
  marks.calib = [];
  calibClickCount = 0;
  calibStatus.textContent = "Click two points across the reference object";
  calibStatus.className = "pill";
});

calibMode.addEventListener('change', ()=>{
  const byObj = calibMode.value==="object";
  document.getElementById('calibObjectField').style.display = byObj? "" : "none";
  calibCustomWrap.style.display = (byObj && calibObject.value==="custom")? "" : "none";
  heightWrap.style.display = byObj? "none" : "";
});
calibObject.addEventListener('change', ()=>{
  calibCustomWrap.style.display = (calibObject.value==="custom")? "" : "none";
});

[btnBust, btnUnderbust, btnWaist, btnHips].forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(pxPerMm==null){ status("Calibrate scale first.", true); return; }
    drawing = btn.dataset.meas;
    marks[drawing] = [];
    drawingWhat.textContent = drawing.charAt(0).toUpperCase()+drawing.slice(1);
    status("Click left and right edges for " + drawing + ".");
  });
});

canvas.addEventListener('click', (ev)=>{
  if(!requireConsent()){ status("Please confirm age and consent first.", true); return; }
  if(!drawing){ return; }
  const pt = canvasPointFromEvent(ev);
  marks[drawing].push(pt);
  if(marks[drawing].length===2){
    if(drawing==="calib"){
      const refMm = getObjectWidthMm();
      const dx = marks.calib[1].x - marks.calib[0].x;
      const dy = marks.calib[1].y - marks.calib[0].y;
      const px = Math.hypot(dx,dy);
      pxPerMm = px / refMm;
      calibStatus.textContent = "Calibrated";
      calibStatus.className = "pill ok";
      pxPerMmEl.textContent = `Scale: ${pxPerMm.toFixed(2)} px/mm`;
      enableMeasurementButtons(true);
    }else{
      computeAndRender();
    }
    drawing = null;
    drawingWhat.textContent = "None";
  }else{
    if(drawing==="calib"){
      calibStatus.textContent = "1/2 points set…";
    }
  }
  drawAll();
});

clearMarksBtn.addEventListener('click', ()=>{
  marks = { calib: marks.calib.length? marks.calib: [], bust: [], underbust: [], waist: [], hips: [] };
  drawing = null;
  drawingWhat.textContent = "None";
  computeAndRender(true);
  drawAll();
});

function computeCircFromWidthMm(widthMm){
  const factor = 2.05;
  return widthMm * factor;
}
function widthPxToMm(px){
  if(pxPerMm) return px / pxPerMm;
  return null;
}
function lineWidthPx(pair){
  const dx = pair[1].x - pair[0].x;
  const dy = pair[1].y - pair[0].y;
  return Math.hypot(dx,dy);
}
function updateBar(el, inches){
  const pct = clamp((inches-24)/(48-24)*100, 0, 100);
  el.style.width = pct.toFixed(1)+"%";
}
function showResult(name, mm){
  if(mm==null){ 
    outs[name+"In"].textContent="— in";
    outs[name+"Cm"].textContent="— cm";
    updateBar(bars[name], 0);
    return;
  }
  const circMm = computeCircFromWidthMm(mm);
  const inches = mmToIn(circMm);
  const cm = circMm/10;
  outs[name+"In"].textContent = inches.toFixed(1) + " in";
  outs[name+"Cm"].textContent = cm.toFixed(1) + " cm";
  updateBar(bars[name], inches);
}
function computeAndRender(clearOnly=false){
  if(clearOnly){
    ["bust","underbust","waist","hips"].forEach(k=>showResult(k,null));
    copyBtn.disabled = true; exportBtn.disabled = true;
    status("");
    return;
  }
  let ready = true;
  ["bust","underbust","waist","hips"].forEach(k=>{
    if(marks[k].length===2){
      const wPx = lineWidthPx(marks[k]);
      const wMm = widthPxToMm(wPx);
      showResult(k, wMm);
    }else{
      showResult(k,null); ready=false;
    }
  });
  copyBtn.disabled = !ready;
  exportBtn.disabled = !ready;
  if(ready){
    status("All measurements captured. Review and export.");
  }else{
    status("Add remaining lines (bust/underbust/waist/hips).");
  }
}

function currentPayload(){
  function val(name){
    const txt = document.getElementById(name+"In").textContent;
    const n = parseFloat(txt);
    return isFinite(n) ? n : null;
  }
  return {
    generatedAt: new Date().toISOString(),
    method: calibMode.value,
    scalePxPerMm: pxPerMm,
    bust_in: val("bust"),
    underbust_in: val("underbust"),
    waist_in: val("waist"),
    hips_in: val("hips"),
    notes: "Single-image estimate; final pattern may include fine-tuning."
  };
}
copyBtn.addEventListener('click', async ()=>{
  const text = JSON.stringify(currentPayload(), null, 2);
  try{
    await navigator.clipboard.writeText(text);
    status("Copied measurements to clipboard.", false, true);
  }catch(e){
    status("Clipboard denied. Use Download JSON instead.", true);
  }
});
exportBtn.addEventListener('click', ()=>{
  const data = new Blob([JSON.stringify(currentPayload(), null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(data);
  const a = document.createElement('a');
  a.href = url;
  a.download = `izzies-bikini-blueprint-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

function status(msg, error=false, success=false){
  statusMsg.textContent = msg || "";
  statusMsg.className = "small " + (error? "danger" : success? "success" : "");
}

function gateChanged(){
  const ok = requireConsent();
  fileInput.disabled = !ok;
  useCameraBtn.disabled = !ok;
  captureBtn.disabled = !ok || !video.srcObject;
  startCalibBtn.disabled = !ok;
}
ageCheck.addEventListener('change', gateChanged);
consentCheck.addEventListener('change', gateChanged);

useCameraBtn.addEventListener('click', ()=>{ if(requireConsent()) startCamera(); });
captureBtn.addEventListener('click', ()=>{ if(requireConsent()) captureFrame(); });

calibMode.dispatchEvent(new Event('change'));

const enableIfImagePresent = ()=>{
  const hasImage = !!imgBitmap || !!video.srcObject;
  startCalibBtn.disabled = !hasImage || !requireConsent();
  clearMarksBtn.disabled = !hasImage;
};
setInterval(enableIfImagePresent, 500);
</script>
</body>
</html>
